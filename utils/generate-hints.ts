import type { Challenge } from '@/types/challenge'

/**
 * CSV 파일에서 챌린지별 구체적인 힌트를 생성하는 유틸리티
 * 
 * CSV의 "문제점 및 개선 방안" 컬럼을 활용하여 각 챌린지에 맞는
 * 구체적이고 실용적인 힌트를 제공합니다.
 */

interface CsvRow {
  guidelineId: number // 고유 번호
  errorType: string // 오류 유형
  solution: string // 문제점 및 개선 방안
}

// CSV 데이터를 메모리에 캐시 (실제로는 서버에서 로드하거나 빌드 타임에 생성)
// 여기서는 챌린지 ID와 kwcagCode를 기반으로 매핑
const HINT_MAPPINGS: Record<string, string> = {
  // 1.1.1 - 정보성 이미지 (informative-image-banner)
  'informative-image-banner': `현재 코드를 보면 <img> 태그에 alt 속성이 누락되어 있습니다.

**문제점**
- alt 속성이 생략되어 이미지 요소의 경로 정보가 스크린 리더로 출력됩니다
- 이미지에 포함된 중요한 정보(할인율, 이벤트 내용 등)를 스크린 리더 사용자가 알 수 없습니다

**개선 방안**
- 이미지가 전달하고자 하는 정보와 동등한 수준의 설명을 대체 텍스트로 제공해야 합니다
- 이미지에 보이는 텍스트(예: "Spring Sale 50% OFF")를 alt 속성에 포함해야 합니다
- 대체 텍스트는 이미지에 포함된 텍스트를 생략하지 않고 동일하게 제공해야 합니다`,

  // 1.1.1 - 장식용 이미지 (decorative-image-icon)
  'decorative-image-icon': `현재 코드를 보면 버튼 내부에 아이콘 이미지와 텍스트가 모두 있습니다.

**문제점**
- 아이콘 이미지에 alt="설정"이 설정되어 있어, 스크린 리더가 "설정 설정"처럼 중복으로 읽을 수 있습니다
- 이미지 요소 전·후에 제공된 텍스트를 통해 이미지에서 전달하고자 하는 정보를 충분히 파악할 수 있습니다

**개선 방안**
- 장식 등 심미적 효과를 위한 이미지에는 대체 텍스트를 생략하고 공백 문자를 제공해야 합니다
- 이미지에 alt 속성을 선언하고 공백문자(alt="")로 속성값을 부여하여 스크린 리더가 요소를 건너뛸 수 있도록 해야 합니다
- 이렇게 하면 "설정" 텍스트만 읽히고 아이콘은 무시됩니다`,

  // 1.1.1 - 복잡한 이미지 (complex-image-chart)
  'complex-image-chart': `현재 코드를 보면 차트 이미지에 alt="차트"만 설정되어 있습니다.

**문제점**
- 이미지가 표현하고 있는 정보의 양이 많고 복잡하므로 단순한 "차트"라는 설명만으로는 충분하지 않습니다
- 스크린 리더 사용자는 차트에 포함된 구체적인 데이터(연도, 금액 등)를 알 수 없습니다

**개선 방안**
- 이미지가 전달하고자 하는 정보와 동등한 수준의 설명을 대체 텍스트로 제공해야 합니다
- 복잡한 데이터 시각화의 경우, 구체적인 수치와 데이터를 포함해야 합니다
- 예: "연도별 매출 막대 그래프: 2020년 1억원, 2021년 1.5억원, 2022년 2억원, 2023년 2.5억원으로 지속적인 성장 추세"
- 또는 aria-describedby를 사용하여 상세 설명을 별도로 연결할 수 있습니다`,

  // 10 (키보드 사용 보장) - keyboard-clickable-div
  'keyboard-clickable-div': `현재 코드를 보면 <div> 요소에 onClick 이벤트만 연결되어 있습니다.

**문제점**
- 상호작용이 불가능한 요소(<div>)에 javascript로 클릭 이벤트를 연결하여 키보드로는 기능을 실행할 수 없습니다
- 키보드 사용자가 Tab 키로 포커스를 이동할 수 없고, Enter나 Space 키로 동작을 실행할 수 없습니다

**개선 방안**
- 컨트롤 요소를 키보드로 접근 및 조작할 수 있도록 상호작용이 가능한 태그(<a>, <button> 등)로 변경해야 합니다
- 또는 커스텀 UI를 키보드로 접근 및 조작할 수 있도록 tabindex 속성을 선언하고, 키보드 이벤트(onKeyDown)를 처리해야 합니다
- role="button"을 추가하여 스크린 리더가 버튼으로 인식하도록 해야 합니다`,

  // 29 (레이블 제공) - form-label-missing
  'form-label-missing': `현재 코드를 보면 <input> 요소에 레이블이 없습니다.

**문제점**
- <input>, <textarea>, <select> 요소에 1:1 대응하는 <label>요소 또는 title 속성을 제공하지 않아 스크린 리더 사용자가 입력서식의 용도를 확인할 수 없습니다
- placeholder 속성만으로는 충분하지 않습니다 (스크린 리더가 무시할 수 있음)

**개선 방안**
- 스크린 리더 사용자가 입력서식의 용도를 확인할 수 있도록 <label>, title, aria-label 중 1가지 방식을 이용하여 이름/설명을 제공해야 합니다
- <label>을 입력 서식과 적절하게 연결하기 위해 <label htmlFor="email">과 <input id="email">을 사용합니다
- 레이블은 웹문서의 주언어 속성과 일치하는 언어로 제공해야 합니다`,

  // 17 (반복 영역 건너뛰기) - skip-link-missing
  'skip-link-missing': `현재 코드를 보면 반복되는 영역(header, nav)을 건너뛸 수 있는 링크가 없습니다.

**문제점**
- 메인 콘텐츠로 이동하기 위한 건너뛰기 링크가 제공되지 않아 키보드 사용자가 웹 페이지에서 반복되는 영역(메인 메뉴 등)을 건너뛰어 핵심 콘텐츠 영역에 빠르게 접근할 수 없습니다
- 매번 헤더와 네비게이션을 거쳐야 본문에 도달할 수 있어 비효율적입니다

**개선 방안**
- 키보드 사용자가 웹 페이지에서 반복되는 영역(메인 메뉴 등)을 건너뛰어 핵심 콘텐츠 영역에 빠르게 접근할 수 있도록 건너뛰기 링크를 제공해야 합니다
- 건너뛰기 링크는 웹 페이지에서 인터랙션할 수 있는 가장 첫 번째 요소로 제공해야 합니다
- 본문 영역에 id 속성을 선언하고, 건너뛰기 링크의 목적지와 동일한 속성값을 제공해야 합니다
- 메인 콘텐츠 영역에 tabindex="-1"을 선언하여 키보드 초점이 목적지로 이동할 수 있게 해야 합니다`,

  // 1.4.3 - 텍스트 콘텐츠의 명도 대비 (contrast-low-text)
  'contrast-low-text': `현재 화면에서 본문 텍스트가 흐리게(연한 회색 등) 보입니다.

**문제점**
- 텍스트와 배경의 명도 대비가 낮으면 저시력 사용자/모바일 환경에서 읽기 어렵습니다
- 대비가 낮으면 중요한 안내 문장을 놓칠 수 있습니다

**개선 방안**
- 텍스트와 배경의 명도 대비를 4.5:1 이상이 되도록 조정해야 합니다
- 본문 텍스트 색상을 더 진하게 변경하거나, 배경을 더 밝게/어둡게 조정해 주세요`,

  // 2.4.7 - 초점 이동과 표시(포커스 표시) (focus-outline-removed)
  'focus-outline-removed': `키보드로 Tab 이동을 했을 때 “현재 포커스가 어디인지” 시각적으로 구분이 어려운 상태입니다.

**문제점**
- 포커스 표시가 없으면 키보드 사용자는 현재 위치를 파악할 수 없습니다
- focus:outline-none 같은 스타일은 기본 포커스 표시를 제거할 수 있습니다

**개선 방안**
- 포커스 표시를 제거했다면, 대체 포커스 스타일(링/아웃라인 등)을 제공해야 합니다
- focus-visible:ring 또는 outline 기반 포커스 표시를 추가해 보세요`,

  // 2.4.4 - 적절한 링크 텍스트 (link-text-ambiguous)
  'link-text-ambiguous': `링크 텍스트가 “더보기”처럼 반복되면, 링크 목록만으로 목적지를 구분하기 어렵습니다.

**문제점**
- 목적이나 용도를 알기 어려운 링크 텍스트는 스크린 리더 사용자에게 혼동을 줍니다
- 같은 문서에 같은 이름의 링크가 여러 개면 “어느 더보기인지” 구분이 어렵습니다

**개선 방안**
- 링크 텍스트만으로 목적을 이해할 수 있도록 구체적인 텍스트를 포함해 주세요
- 예: “서비스 점검 안내 더보기”, “개인정보 처리방침 변경 더보기”`,

  // 4.1.1 - 마크업 오류 방지 (duplicate-id)
  'duplicate-id': `같은 id 값이 여러 번 사용되면 마크업 오류가 발생하고 레이블 연결이 깨질 수 있습니다.

**문제점**
- 한 페이지 안에 동일한 id 값이 존재하면 요소를 정확히 식별하기 어렵습니다
- label의 for/id 연결이 의도대로 동작하지 않을 수 있습니다

**개선 방안**
- id는 문서 내에서 유일해야 합니다
- 각 입력 필드마다 고유한 id를 부여하고, label의 for 속성도 그에 맞춰 수정해 주세요`,

  // 1.3.1 - 표의 구성(정보/관계) (table-header-missing)
  'table-header-missing': `데이터 테이블은 제목 셀과 데이터 셀의 관계가 보조기술에 전달되어야 합니다.

**문제점**
- 제목/헤더 역할을 하는 셀이 <td>로 제공되면 표 구조를 이해하기 어렵습니다
- 헤더와 데이터의 관계(행/열)가 명확하지 않으면 탐색 시 혼동이 생깁니다

**개선 방안**
- 헤더는 <th>로 제공하고, scope="col"/"row"로 관계를 명시해 주세요
- 필요하다면 <caption>, <thead>, <tbody>로 구조를 더 명확히 구성해 보세요`,

  // 1.4.1 - 색에 무관한 콘텐츠 인식 (color-only-required)
  'color-only-required': `필수 입력을 빨간색(*)만으로 표시하면, 색을 구분하기 어려운 사용자에겐 정보가 전달되지 않을 수 있습니다.

**문제점**
- 색상만으로 상태/의미(필수 여부)를 전달하면 색각 이상 사용자에게 불리합니다
- 기호(*)만으로는 스크린 리더/키보드 사용자에게 충분한 정보가 아닐 수 있습니다

**개선 방안**
- 필수 여부를 색상 외 수단(텍스트, 숨김 텍스트 등)으로도 제공해야 합니다
- (필수) 같은 텍스트를 추가하고, 시각적으로 숨길 경우 sr-only 같은 접근성 숨김 기법을 적용해 보세요`,
}

/**
 * 챌린지에 맞는 구체적인 힌트를 생성합니다
 */
export function generateHintForChallenge(challenge: Challenge | null): string {
  if (!challenge) {
    return '코드를 자세히 살펴보고 문제점을 찾아보세요.'
  }

  // 챌린지 ID로 직접 매핑
  const hint = HINT_MAPPINGS[challenge.id]
  if (hint) {
    return hint
  }

  // kwcagCode 기반으로 기본 힌트 생성
  const kwcagCode = challenge.kwcagCode
  if (kwcagCode === '1.1.1') {
    return `이미지 요소에 대한 접근성을 확인해보세요. 
- 정보를 전달하는 이미지인가요? 그렇다면 alt 속성에 구체적인 설명이 필요합니다.
- 단순히 장식용인가요? 그렇다면 alt=""로 설정해야 합니다.
- 복잡한 데이터(차트, 그래프)인가요? 그렇다면 상세한 데이터를 포함해야 합니다.`
  }

  if (kwcagCode === '10' || kwcagCode === '2.1.1') {
    return `키보드 접근성을 확인해보세요.
- 모든 상호작용 요소가 키보드로 접근 가능한가요?
- div나 span에 onClick만 있는 경우, 키보드 사용자는 사용할 수 없습니다.
- role, tabIndex, 키보드 이벤트 처리가 필요합니다.`
  }

  if (kwcagCode === '29' || kwcagCode === '3.3.2') {
    return `입력 필드의 레이블을 확인해보세요.
- 모든 input, textarea, select에 레이블이 연결되어 있나요?
- <label htmlFor="...">와 <input id="...">를 사용하여 연결해야 합니다.
- placeholder만으로는 충분하지 않습니다.`
  }

  if (kwcagCode === '17' || kwcagCode === '2.4.1') {
    return `반복 영역 건너뛰기 링크를 확인해보세요.
- 헤더나 네비게이션 같은 반복되는 영역을 건너뛸 수 있는 링크가 있나요?
- "본문 바로가기" 같은 건너뛰기 링크를 페이지 최상단에 제공해야 합니다.
- 본문 영역에 id를 설정하고 링크로 연결해야 합니다.`
  }

  return '코드를 자세히 살펴보고 문제점을 찾아보세요.'
}

